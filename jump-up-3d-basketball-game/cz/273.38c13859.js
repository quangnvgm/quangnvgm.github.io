"use strict";(globalThis.webpackChunkcrazygames_gameframe=globalThis.webpackChunkcrazygames_gameframe||[]).push([[273,6327],{36327:(e,t,s)=>{s.r(t),s.d(t,{IFRAME_LOADER_IFRAME_ID:()=>p,default:()=>y});var a=s(47313),r=s(90831),i=s(23004),o=s(25831),n=s(73411),d=s(86604),h=s(95681),c=s(19496),l=s(6689),m=s(71534),g=s(87308),u=s(46417);const p="game-iframe";class S extends a.Component{constructor(e){super(e),this.config=void 0,this.options=void 0,this.progressTracker=void 0,this.iframe=null,this.onIframeLoad=()=>{this.progressTracker.trackLoadFinished(),this.onLoad(),this.focusOnIframe()},this.onLoad=()=>{"loaded"!==this.state.state&&(this.setState({state:"loaded"}),setTimeout((()=>{this.setState({showLoadingBar:!1})}),600),this.props.onLoadFinished())},this.onFullscreenClose=async()=>{await this.props.requestFullscreen(),this.startLoading()},this.adFinished=()=>{this.focusOnIframe()},this.config=(0,r.NI)(),this.options=this.config.loaderOptions,this.state={state:"checking",showLoadingBar:!1},this.progressTracker=new h.Z}componentDidMount(){const e=(0,g.uo)();"REQUIRED"!==this.config.fullscreen||e||this.props.isFullscreen?this.startLoading():this.setState({state:"fullscreen"}),(0,c.Q)().addAdFinishedListener(this.adFinished)}componentWillUnmount(){(0,c.Q)().removeAdFinishedListener(this.adFinished)}componentDidUpdate(e){e.isFullscreen!==this.props.isFullscreen&&this.focusOnIframe()}renderForState(){const{state:e}=this.state;switch(e){case"checking":return this.renderChecking();case"fullscreen":return this.renderFullscreenOverlay();case"loaded":return this.renderLoaded();default:throw new Error(`[IFrameLoader] unexpected state ${e}`)}}render(){return(0,u.jsxs)(u.Fragment,{children:[this.renderForState(),this.state.showLoadingBar&&this.renderLoading()]})}renderChecking(){return(0,u.jsx)(n.Z,{showProgress:!1})}renderFullscreenOverlay(){return(0,u.jsx)(d.Z,{warning:"force-fullscreen",close:this.onFullscreenClose})}renderLoading(){return(0,u.jsx)(n.Z,{showProgress:!1})}renderLoaded(){return null}loadIframe(){const{scrolling:e}=this.options,{sandbox:t}=this.config,s=this.config.allowWebCam?"camera;":"",a=document.createElement("iframe");if(a.id=p,a.src=this.getIframeUrl(),a.onload=this.onIframeLoad,a.style.border="0",a.style.backgroundColor="#fff",e&&a.setAttribute("scrolling",e),a.style.width="10px",a.style.height="10px",a.style.minWidth="100%",a.style.minHeight="100%",a.setAttribute("allow",`${s} autoplay; payment; fullscreen; microphone; clipboard-read; clipboard-write 'self' ${a.src}`),a.setAttribute("webkitallowfullscreen","true"),a.setAttribute("mozallowfullscreen","true"),a.setAttribute("msallowfullscreen","true"),a.setAttribute("allowfullscreen","true"),t){a.setAttribute("sandbox","");const e=["allow-forms","allow-modals","allow-orientation-lock","allow-pointer-lock","allow-popups","allow-presentation","allow-scripts","allow-same-origin","allow-downloads"];a.sandbox.add(...e)}this.iframe=a;(0,i.$7)().appendChild(a)}async startLoading(){this.setState({showLoadingBar:!0});try{await l.Z.Instance.waitForAPS()}catch(e){}finally{this.loadIframe(),this.progressTracker.trackLoadStarted(),setTimeout((()=>{this.onLoad()}),1e4)}}getIframeUrl(){const e=new URL(this.options.url);return new URLSearchParams(window.location.search).forEach(((t,s)=>{e.searchParams.append(s,t)})),e.toString().includes("html5.gamedistribution.com")&&e.searchParams.set("gd_sdk_referrer_url",this.config.gameLink),e.toString()}focusOnIframe(){this.iframe&&this.iframe.contentWindow&&this.iframe.contentWindow.focus()}}const y=(0,o.Z)((0,m.q)(S))},86604:(e,t,s)=>{s.d(t,{Z:()=>h});s(47313);var a=s(9172),r=s(99187),i=s(46604),o=s(69121),n=s(40889),d=s(46417);const h=e=>{let{warning:t,close:s,showCrazyLogo:h=!0}=e;const{countryCode:c}=(0,o.bG)(),l=(0,o.Ax)(c)&&i.Z.isEmbeddedExternally();return(0,d.jsxs)(r.Z,{showCrazyLogo:h,showGDPRNotice:l,children:[(0,d.jsx)(a.Z,{close:s,warning:t}),(0,d.jsx)(n.Z,{hasFooter:!1,disableMove:!0})]})}},95681:(e,t,s)=>{s.d(t,{Z:()=>n});var a=s(22870),r=s(20505);const i=class{constructor(){this.loadStartedSent=void 0,this.firstQuarterSent=void 0,this.secondQuarterSent=void 0,this.thirdQuarterSent=void 0,this.ninetyPercentSent=void 0,this.loadFinishedSent=void 0,this.ga=void 0,this.ga=r.Z.Instance,this.loadStartedSent=!1,this.firstQuarterSent=!1,this.secondQuarterSent=!1,this.thirdQuarterSent=!1,this.ninetyPercentSent=!1,this.loadFinishedSent=!1}trackLoadStarted(){this.loadStartedSent?a.kg.warn("trackLoadStarted called multiple times"):(this.loadStartedSent=!0,this.ga.trackLoadStarted())}trackProgress(e){!this.firstQuarterSent&&e>=.25&&(this.ga.trackFirstQuarterLoaded(),this.firstQuarterSent=!0),!this.secondQuarterSent&&e>=.5&&(this.ga.trackSecondQuarterLoaded(),this.secondQuarterSent=!0),!this.thirdQuarterSent&&e>=.75&&(this.ga.trackThirdQuarterLoaded(),this.thirdQuarterSent=!0),!this.ninetyPercentSent&&e>=.9&&(this.ga.trackNinetyPercentLoaded(),this.ninetyPercentSent=!0)}trackLoadFinished(){this.loadStartedSent?this.loadFinishedSent?a.kg.warn("trackLoadFinished called multiple times"):(this.loadFinishedSent=!0,this.ga.trackLoadFinished()):a.kg.warn("trackLoadFinished called before trackLoadStart was called")}};var o=s(96607);const n=class{constructor(){this.lastReportedProgress=void 0,this.currentProgress=0,this.tracker=void 0,this.tracker=new i}reset(){this.lastReportedProgress=void 0,this.currentProgress=0,this.tracker=new i}trackLoadStarted(){o.Z.trackProgress(0),this.lastReportedProgress=0,this.tracker.trackLoadStarted()}trackProgress(e){if(e<=this.currentProgress)return this.currentProgress;this.currentProgress=e,this.tracker.trackProgress(e);const t=Math.floor(10*e)/10;return 1!==t&&(!this.lastReportedProgress||e>this.lastReportedProgress+.1)&&(o.Z.trackProgress(t),this.lastReportedProgress=e),e}trackLoadFinished(){1!==this.lastReportedProgress&&(this.lastReportedProgress=1,this.tracker.trackLoadFinished(),o.Z.trackProgress(1),o.Z.loadFinished())}}},73411:(e,t,s)=>{s.d(t,{Z:()=>U});var a=s(7883),r=(s(47313),s(90831)),i=s(42379),o=s(30686),n=s(32606);const d=(0,i.ZP)("div")((e=>{let{theme:t}=e;return{fontSize:"14px",color:"#FFFFFF",display:"flex",gap:t.spacing(.5),height:40}})),h=(0,i.ZP)("div")({fontWeight:700}),c=(0,i.ZP)("div")({fontWeight:400}),l=(0,i.ZP)("div")({height:12,borderRadius:6,backgroundColor:"black",position:"relative"}),m=(0,i.ZP)("div",{shouldForwardProp:e=>"percentage"!==e})((e=>{let{percentage:t}=e;return{position:"absolute",backgroundColor:n.D.brand[100],left:0,top:0,bottom:0,borderRadius:6,width:100*t+"%"}})),g=o.F4`
  0% { width: 5%; }
  100% { width: 100%; }
`,u=(0,i.ZP)("div")({backgroundColor:"#ffffff",position:"absolute",borderRadius:6,top:0,height:"100%",left:0,right:0,opacity:.3,animation:`${g} 1s infinite`}),p=o.F4`
  0% {
    left:0%;
    right:100%;
    width:0%;
  }
  10% {
    left:0%;
    right:75%;
    width:25%;
  }
  90% {
    right:0%;
    left:75%;
    width:25%;
  }
  100% {
    left:100%;
    right:0%;
    width:0%;
  }
`,S=(0,i.ZP)("div")({position:"absolute",backgroundColor:n.D.brand[100],borderRadius:6,top:0,right:"100%",bottom:0,left:0,width:0,animation:`${p} 2s linear infinite`}),y=o.F4`
  0% {
    opacity:0;
  }
  17% {
    opacity:1;
  }
  83% {
   opacity:1;
  }
  100% {
    opacity: 0;
  }
`,f=o.F4`
  0% {
    opacity:0;
  }
  100% {
    opacity:1;
  }
`,D=(0,i.ZP)("div")({"& div":{position:"absolute",left:"50%",transform:"translate(-50%)",opacity:0,animation:`${y} 3s linear 1`},"& .msg0":{animation:`${y} 3s linear 1`},"& .msg1":{animationDelay:"3s"},"& .msg2":{animationDelay:"6s"},"& .msg3":{animationDelay:"9s"},"& .msg4":{animationDelay:"12s"},"& .msg5":{animationDelay:"15s"},"& .msg6":{animationDelay:"18s"},"& .msg7":{animationDelay:"21s"},"& .msg8":{animationDelay:"24s"},"& .msg9":{animationDelay:"27s"},"& .msg10":{animationDelay:"30s"},"& .msg11":{animationDelay:"33s"},"& .msg12":{animationDelay:"36s"},"& .msg13":{animationDelay:"39s"},"& .msg14":{animationDelay:"42s"},"& .msg15":{animationDelay:"45s"},"& .msg16":{animationDelay:"48s"},"& .msg17":{animationDelay:"51s"},"& .msg18":{animationDelay:"54s"},"& .msg19":{animationDelay:"57s"},"& .msg20":{animationDelay:"60s"},"& .msg21":{animationDelay:"63s"},"& .msg22":{animationDelay:"66s"},"& .msg23":{animation:`${f} 2s linear 1`,animationDelay:"69s",animationFillMode:"forwards"}});var P=s(46417);const v=()=>{const e=[a.ag._("loadingBarScreen.message1"),a.ag._("loadingBarScreen.message2"),a.ag._("loadingBarScreen.message3"),a.ag._("loadingBarScreen.message4"),a.ag._("loadingBarScreen.message5"),a.ag._("loadingBarScreen.message6"),a.ag._("loadingBarScreen.message7"),a.ag._("loadingBarScreen.message8")],t=[...e,...e,...e];return(0,P.jsx)(D,{children:t.map(((e,t)=>(0,P.jsx)("div",{className:`msg${t}`,children:e},t)))})};var w=s(93458);const U=e=>{let{progress:t,showProgress:s}=e;const i=(0,r.NI)(),o=t<=.95,g=s&&!o||!s;return(0,P.jsx)("div",{style:{position:"fixed",inset:0,zIndex:2,background:n.D.black[90]},children:(0,P.jsx)(w.Z,{children:s?(()=>{const e=i.totalSizeBytes?Math.round(1e-6*i.totalSizeBytes):null;return(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(l,{sx:{width:"80%"},children:(0,P.jsx)(m,{percentage:t,children:(0,P.jsx)(u,{})})}),(0,P.jsxs)(d,{children:[(0,P.jsx)(h,{children:o?`${Math.round(100*t)}%`:g?(0,P.jsx)(v,{}):a.ag._("loadingBarScreen.message1")}),o&&e&&(0,P.jsxs)(c,{children:["(",Math.round(t*e)," / ",e," MB)"]})]})]})})():(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(l,{sx:{width:"80%"},children:(0,P.jsx)(S,{})}),(0,P.jsx)(h,{children:g?(0,P.jsx)(v,{}):a.ag._("loadingBarScreen.message1")})]})})})}},28438:(e,t,s)=>{s.d(t,{Z:()=>i});s(47313);var a=s(60551),r=s(46417);const i=function(e){return t=>(0,r.jsx)(a.W9.Consumer,{children:s=>(0,r.jsx)(e,{upConnector:s,...t})})}},80273:(e,t,s)=>{s.r(t),s.d(t,{default:()=>O});var a=s(47313),r=s(90831),i=s(64819),o=s(91469),n=s(18332),d=s(61627),h=s(23004),c=s(96607),l=s(13751),m=s(6689),g=s(42379),u=s(85541),p=s(46417);const S=a.memo((e=>(0,p.jsx)(u.Z,{...e,width:"24",height:"24",viewBox:"0 0 30 30",children:(0,p.jsx)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M5 3.75C5.69036 3.75 6.25 4.30964 6.25 5V7.92873C8.31173 5.38058 11.4646 3.75 15 3.75C20.7379 3.75 25.4709 8.04455 26.163 13.5953C26.2485 14.2804 25.7624 14.905 25.0773 14.9904C24.3923 15.0758 23.7677 14.5897 23.6822 13.9047C23.1442 9.58967 19.4611 6.25 15 6.25C12.0279 6.25 9.39998 7.73208 7.81803 10H11.25C11.9404 10 12.5 10.5596 12.5 11.25C12.5 11.9404 11.9404 12.5 11.25 12.5H5C4.30964 12.5 3.75 11.9404 3.75 11.25V5C3.75 4.30964 4.30964 3.75 5 3.75ZM4.92269 15.0096C5.60774 14.9242 6.23234 15.4103 6.31776 16.0953C6.85583 20.4103 10.5389 23.75 15 23.75C17.9721 23.75 20.6 22.2679 22.182 20H18.75C18.0596 20 17.5 19.4404 17.5 18.75C17.5 18.0596 18.0596 17.5 18.75 17.5H25C25.6904 17.5 26.25 18.0596 26.25 18.75V25C26.25 25.6904 25.6904 26.25 25 26.25C24.3096 26.25 23.75 25.6904 23.75 25V22.0713C21.6883 24.6194 18.5354 26.25 15 26.25C9.26209 26.25 4.52915 21.9555 3.83697 16.4047C3.75155 15.7196 4.23764 15.095 4.92269 15.0096Z"})})));var y=s(91423),f=s(32606);const D=(0,g.ZP)("div")((e=>{let{theme:{palette:t}}=e;return{opacity:.9,backgroundColor:"rgba(0, 0, 0, 0.85)",position:"absolute",left:0,top:0,height:"100vh",width:"100vw",zIndex:1}})),P=(0,g.ZP)("div")({backgroundColor:f.D.brand[200],display:"flex",alignItems:"center",justifyContent:"center",position:"absolute",left:0,top:0,height:"100vh",width:"100vw",zIndex:2}),v=(0,g.ZP)("div")((e=>{let{theme:{typography:t}}=e;return{alignItems:"center",alignSelf:"center",backgroundColor:f.D.black[70],borderRadius:20,boxShadow:"0 10px 20px 0 rgba(0, 0, 0, 0.3)",display:"flex",flexDirection:"column",fontFamily:t.fontFamily,justifyContent:"center",padding:20,position:"relative",maxWidth:"100%",width:340}})),w=(0,g.ZP)(S)({fill:f.D.brand[60],height:48,width:48}),U=(0,g.ZP)("div")((e=>{let{theme:{spacing:t}}=e;return{color:f.D.white[100],fontSize:20,fontWeight:700,textAlign:"center",margin:`${t(2)} 0 ${t()}`}})),I=(0,g.ZP)("div")((e=>{let{theme:t}=e;return{color:f.D.white[60],fontSize:"16px",fontWeight:400,lineHeight:"22px",textAlign:"center",marginBottom:t.spacing(2)}})),x=(0,g.ZP)("span")({color:f.D.brand[60]}),L=(0,g.ZP)(y.Z)((e=>{let{theme:t}=e;return{backgroundColor:f.D.brand[100],color:f.D.white[60],fontFamily:t.typography.fontFamily,fontSize:"16px",fontWeight:800,justifyContent:"center",padding:8,textAlign:"center",textTransform:"none",width:"100%"}}));var T=s(77626);const F=e=>{let{onReload:t}=e;return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(D,{}),(0,p.jsx)(P,{children:(0,p.jsxs)(v,{children:[(0,p.jsx)(w,{}),(0,p.jsx)(U,{children:(0,p.jsx)(T.Z,{id:"aps.reload.title"})}),(0,p.jsx)(I,{children:(0,p.jsx)(T.Z,{id:"aps.reload.text",values:{highlight:(0,p.jsx)(x,{children:(0,p.jsx)(T.Z,{id:"aps.reload.textHighlight"})})}})}),(0,p.jsx)(L,{onClick:t,children:(0,p.jsx)(T.Z,{id:"aps.reload.title"})})]})})]})};var b=s(28438),A=s(22870),k=s(71534),Z=s(36327),j=s(11414),C=s(60551);class G extends a.PureComponent{constructor(e,t){super(e),this.context=void 0,this.config=void 0,this.apsLoaded=!1,this.apsInterjectorIframe=null,this.apsInterjectorPromise=null,this.apsStorageKey=void 0,this.apiData=null,this.hasUserLoaded=!1,this.hasAPSUser=void 0,this.hasDelayedAPSUser=!1,this.timeout=void 0,this.scriptEvents=[],this.logger=(0,A.fq)((0,l.Qg)()).withPrefix("[APS-Iframe]"),this.isFetchingGameDataFromSignedUrl=!1,this.isWaitingForGameDataUrlFromUP=!1,this.checkForUser=()=>{this.context.userId&&void 0===this.hasAPSUser?this.handleForUser():this.context.userId||this.handleForNoUser(),this.hasUserLoaded=this.context.hasUserLoaded},this.processMessage=async e=>{try{const{type:t}=e.data;switch(t){case"loadGame":this.onMessageLoadGame();break;case"reloadPopup":this.onMessageReloadPopup();break;case"sessionconflict":this.onMessageAPSSessionConflict();break;case"replaceGameData":await this.props.upConnector.replaceGameData(e.data.data);break;case"clearGameData":await this.props.upConnector.clearGameData(e.data.data);break;case"setUserStorage":await this.props.upConnector.setUserStorage(e.data.data)}}catch(s){var t;console.error("message error: ",s),null===(t=this.apsInterjectorPromise)||void 0===t||t.reject()}},this.handleForUser=async()=>{const{getGameData:e}=this.props.upConnector;this.logger.debug("has user: "),m.Z.Instance.setType("IFRAME"),this.hasAPSUser=!0,window.addEventListener("message",this.processMessage);try{var t;this.isWaitingForGameDataUrlFromUP=!0;const s=await e();if(this.isWaitingForGameDataUrlFromUP=!1,s.errors||!s.resultData)return this.handleSendMsgToScript("requestGameDataNone"),this.logger.error("GetGameData error",JSON.stringify(s.errors)),void c.Z.trackAPSIssue("fetch-error","iframe",this.hasUserLoaded,this.apsLoaded);if(null===(t=s.resultData.gameData)||void 0===t||!t.dataUrl)return void this.onMessageRequestGameDataResponse(void 0);this.isFetchingGameDataFromSignedUrl=!0;const a=await(0,l.do)(s.resultData.gameData.dataUrl);this.isFetchingGameDataFromSignedUrl=!1;const r={data:a,metadata:s.resultData.gameData.metadata,version:s.resultData.gameData.version};this.onMessageRequestGameDataResponse(r)}catch(s){this.handleSendMsgToScript("requestGameDataNone"),this.logger.error("[APS-U] Error fetching data from signed URL",JSON.stringify(s)),s instanceof C.W5?c.Z.trackAPSIssue("fetch-error-gfconnector","iframe",this.hasUserLoaded,this.apsLoaded):c.Z.trackAPSIssue("fetch-error","iframe",this.hasUserLoaded,this.apsLoaded)}},this.handleForNoUser=()=>{var e;this.logger.debug("has no user: "),this.hasAPSUser=!1,this.handleSendMsgToScript("requestGameDataNone"),null===(e=this.apsInterjectorPromise)||void 0===e||e.resolve(),window.clearTimeout(this.timeout)},this.onMessageLoadGame=()=>{var e;null===(e=this.apsInterjectorPromise)||void 0===e||e.resolve(),window.clearTimeout(this.timeout)},this.onMessageAPSSessionConflict=()=>{c.Z.trackAPSSessionConflict("iframe",this.hasUserLoaded,this.apsLoaded)},this.onMessageReloadPopup=()=>{"NOT_STARTED"!==this.props.gameLoadStatus?this.setState({showReloadPopup:!0}):this.apiData&&this.handleSendMsgToScript("handleReloadData",this.apiData)},this.onSelectReload=async()=>{c.Z.trackAPSPromptSelection((0,r.NI)().loader,"Account","Auto",this.hasDelayedAPSUser?"Delayed":"Initial");const e=document.getElementById(Z.IFRAME_LOADER_IFRAME_ID);e&&e.contentWindow?(this.apiData&&this.handleSendMsgToScript("handleReloadData",this.apiData),e.src=`${e.src}`,this.setState({showReloadPopup:!1})):window.location.reload()},this.onMessageRequestGameDataResponse=e=>{if(!e)return this.apiData=null,void this.handleSendMsgToScript("requestGameDataResponse");const t=(0,n.Z)(e.metadata.updatedAt,"yyyy-MM-dd HH:mm:ss",new Date),s=(0,i.Z)((0,o.Z)(t,-t.getTimezoneOffset()),"T");this.apiData={...e,hasDelayedUser:this.hasDelayedAPSUser,metadata:{...e.metadata,updatedAtTz:s}},this.handleSendMsgToScript("requestGameDataResponse",this.apiData)},this.loadAPSInterjector=()=>{const e=document.createElement("iframe");e.src=(0,l.z6)(this.config.gameSlug,this.apsStorageKey,this.props.loader,(0,l.VB)()),e.style.display="none",e.onload=()=>{this.apsLoaded=!0,this.context.hasUserLoaded&&this.checkForUser(),this.scriptEvents.length>0&&(this.scriptEvents.forEach(this.sendMsgToScript),this.scriptEvents=[])},e.onerror=e=>{var t;null===(t=this.apsInterjectorPromise)||void 0===t||t.reject(e)},document.body.appendChild(e),this.apsInterjectorIframe=e},this.onPreloadGame=async()=>{const e=(0,h.PQ)();m.Z.Instance.setDeferred(e);try{this.apsInterjectorPromise=(0,h.PQ)(),this.loadAPSInterjector(),await this.apsInterjectorPromise.promise}catch(t){console.error("preload error:",t)}finally{e.resolve()}m.Z.Instance.setIsDeferredFinished(!0)},this.sendMsgToScript=e=>{var t,s;let{type:a,data:r}=e;null===(t=this.apsInterjectorIframe)||void 0===t||null===(s=t.contentWindow)||void 0===s||s.postMessage({type:a,data:r},"*")},this.handleSendMsgToScript=(e,t)=>{this.apsLoaded?this.sendMsgToScript({type:e,data:t}):this.scriptEvents.push({type:e,data:t})},this.startGameDataTimeout=async()=>{const e=(0,l.i2)(this.context.isUserExpected);this.timeout=window.setTimeout((()=>{var t;this.hasAPSUser=!1,this.logger.debug(`timeout exceeded: ${e}, user ${this.hasUserLoaded?"loaded":"not-loaded"}, script ${this.apsLoaded?"loaded":"not-loaded"}`);const s=this.getApsTimeoutIssueType();c.Z.trackAPSIssue(s,"iframe",this.hasUserLoaded,this.apsLoaded,{timer:e}),null===(t=this.apsInterjectorPromise)||void 0===t||t.reject("timeout exceeded")}),e)},this.getApsTimeoutIssueType=()=>this.context.userId&&this.context.hasUserLoaded?this.isWaitingForGameDataUrlFromUP?"up-timeout":this.isFetchingGameDataFromSignedUrl?"fetch-timeout":"timeout":"firebase-timeout",this.config=(0,r.NI)(),this.apsStorageKey=(0,j.Z5)(),this.hasUserLoaded=t.hasUserLoaded,this.logger.debug("enabled:"),this.logger.debug(`version ${l.bs}`),this.state={showReloadPopup:!1}}componentDidMount(){var e;(0,l.VO)("Loading iframe loader"),this.onPreloadGame(),this.hasUserLoaded=this.context.hasUserLoaded,null!==(e=this.context)&&void 0!==e&&e.userId&&this.handleForUser();"NOT_STARTED"!==this.props.gameLoadStatus&&!m.Z.Instance.getIsDeferredFinished()&&this.startGameDataTimeout()}componentDidUpdate(e){if(this.apsLoaded&&this.context.hasUserLoaded&&!this.hasUserLoaded)this.checkForUser();else if(this.context.userId&&!1===this.hasAPSUser&&this.hasUserLoaded){"NOT_STARTED"!==this.props.gameLoadStatus&&(this.hasDelayedAPSUser=!0),this.handleForUser()}const t="NOT_STARTED"!==this.props.gameLoadStatus;"NOT_STARTED"!==e.gameLoadStatus||!t||m.Z.Instance.getIsDeferredFinished()||this.startGameDataTimeout()}componentWillUnmount(){window.removeEventListener("message",this.processMessage)}render(){return(0,p.jsx)(p.Fragment,{children:this.state.showReloadPopup&&(0,p.jsx)(F,{onReload:this.onSelectReload})})}}G.contextType=d.N;const R=(0,k.q)((0,b.Z)(G));var M=s(52012);class N extends a.PureComponent{constructor(e,t){super(e),this.context=void 0,this.apsLoadPromise=null,this.hasAPSUser=void 0,this.hasDelayedAPSUser=!1,this.timeout=void 0,this.apiData=null,this.logger=(0,A.fq)((0,l.Qg)()).withPrefix("[APS-Unity]"),this.isFetchingGameDataFromSignedUrl=!1,this.isWaitingForGameDataUrlFromUP=!1,this.syncTimerInterval=void 0,this.processSDKMessage=async e=>{try{const{type:t}=e.data;if("syncUnityGameData"===t){if(this.logger.debug("syncUnityGameData requested"),"disabled"===m.Z.Instance.getCurrentSyncType())return void this.logger.warn("syncUnityGameData request rejected");this.props.upConnector.syncUnityData(!0),m.Z.Instance.setCurrentSyncType("sdk"),this.clearUnitySyncTime()}}catch(s){var t;console.error("message err: ",s),null===(t=this.apsLoadPromise)||void 0===t||t.reject()}},this.handleForUser=async()=>{if(!this.context.userId||!this.context.hasUserLoaded||this.hasAPSUser)return;const{getGameData:e}=this.props.upConnector;this.logger.debug("has user: "),m.Z.Instance.setType("UNITY");const t="NOT_STARTED"!==this.props.gameLoadStatus;!1===this.hasAPSUser&&t&&(this.hasDelayedAPSUser=!0),this.hasAPSUser=!0;try{var s;this.isWaitingForGameDataUrlFromUP=!0;const t=await e();if(this.isWaitingForGameDataUrlFromUP=!1,t.errors||!t.resultData)return this.logger.error("GetGameData error",JSON.stringify(t.errors)),this.handleGameDataFailure("GetGameData error"),void c.Z.trackAPSIssue("fetch-error",(0,r.NI)().loader,this.context.hasUserLoaded,!1);if(null===(s=t.resultData.gameData)||void 0===s||!s.dataUrl)return void this.onMessageRequestGameDataResponse(void 0);this.isFetchingGameDataFromSignedUrl=!0;const a=await(0,l.do)(t.resultData.gameData.dataUrl);this.isFetchingGameDataFromSignedUrl=!1;const i={data:a,metadata:t.resultData.gameData.metadata,version:t.resultData.gameData.version};this.onMessageRequestGameDataResponse(i)}catch(a){this.logger.error("Error fetching data from signed URL",JSON.stringify(a)),this.handleGameDataFailure("GetGameData error"),a instanceof C.W5?c.Z.trackAPSIssue("fetch-error-gfconnector",(0,r.NI)().loader,this.context.hasUserLoaded,!1):c.Z.trackAPSIssue("fetch-error",(0,r.NI)().loader,this.context.hasUserLoaded,!1)}},this.handleForNoUser=()=>{void 0===this.hasAPSUser&&this.context.hasUserLoaded&&(this.logger.debug("has no user: "),this.hasAPSUser=!1,this.onMessageLoadGame())},this.onMessageLoadGame=()=>{var e;null===(e=this.apsLoadPromise)||void 0===e||e.resolve(),this.clearGameDataTimeout()},this.onMessageRequestGameDataResponse=async e=>{if(!e)return m.Z.Instance.setCurrentSyncType("aps"),this.handleUnitySyncTimeStart(),await this.props.upConnector.syncUnityData(!1),void this.onMessageLoadGame();const t=(0,n.Z)(e.metadata.updatedAt,"yyyy-MM-dd HH:mm:ss",new Date),s=parseInt((0,i.Z)((0,o.Z)(t,-t.getTimezoneOffset()),"T"));let a;try{a=await(0,M.getExistingPlayerPrefUpdatedAtTz)()}catch(d){this.logger.debug("Existing data err: ",d)}return this.hasDelayedAPSUser?(this.logger.debug("reload game popup"),this.apiData={store:e,apiUpdatedAtTz:s},void this.setState({showReloadPopup:!0})):(m.Z.Instance.setCurrentSyncType("aps"),this.handleUnitySyncTimeStart(),a?a===s?(this.logger.debug("same"),(0,M.setSyncTimeOfIndexDb)(a),void this.onMessageLoadGame()):a>s&&a-s<(0,M.getSyncTimerMs)()?(this.logger.debug("choosing LS",a,s),c.Z.trackAPSPromptSelection((0,r.NI)().loader,"Browser","Auto","Initial"),await this.props.upConnector.syncUnityData(!1),void this.onMessageLoadGame()):(this.logger.debug("choosing API"),c.Z.trackAPSPromptSelection((0,r.NI)().loader,"Account","Auto","Initial"),await(0,M.setAPIDataToIDB)(e,s),void this.onMessageLoadGame()):(this.logger.debug("no local"),await(0,M.setAPIDataToIDB)(e,s),void this.onMessageLoadGame()))},this.onSelectReload=async()=>{c.Z.trackAPSPromptSelection((0,r.NI)().loader,"Account","Auto",this.hasDelayedAPSUser?"Delayed":"Initial"),this.apiData&&await(0,M.setAPIDataToIDB)(this.apiData.store,this.apiData.apiUpdatedAtTz),window.location.reload()},this.onPreloadGame=async()=>{const e=(0,h.PQ)();m.Z.Instance.setDeferred(e);try{this.apsLoadPromise=(0,h.PQ)(),await this.apsLoadPromise.promise}catch(t){console.error("preload error:",t)}finally{e.resolve()}m.Z.Instance.setIsDeferredFinished(!0)},this.getTimeoutApsIssueType=()=>this.context.userId&&this.context.hasUserLoaded?this.isWaitingForGameDataUrlFromUP?"up-timeout":this.isFetchingGameDataFromSignedUrl?"fetch-timeout":"timeout":"firebase-timeout",this.handleGameDataTimeoutStart=async()=>{if("NOT_STARTED"===this.props.gameLoadStatus||m.Z.Instance.getIsDeferredFinished()||void 0!==this.timeout)return;const e=(0,l.i2)(this.context.isUserExpected);this.timeout=window.setTimeout((()=>{var t;this.hasAPSUser=!1,this.logger.debug(`timeout exceeded: ${e}, user ${this.context.hasUserLoaded?"loaded":"not-loaded"}`);const s=this.getTimeoutApsIssueType();c.Z.trackAPSIssue(s,(0,r.NI)().loader,this.context.hasUserLoaded,!1,{timer:e}),null===(t=this.apsLoadPromise)||void 0===t||t.reject("timeout exceeded")}),e)},this.handleGameDataFailure=e=>{var t;null===(t=this.apsLoadPromise)||void 0===t||t.reject(e),this.clearGameDataTimeout()},this.logger.debug("enabled"),this.state={showReloadPopup:!1}}componentDidMount(){(0,l.VO)("Loading Unity loader"),this.onPreloadGame(),this.handleUserLogic(),this.handleGameDataTimeoutStart(),this.handleUnitySyncTimeStart(),window.addEventListener("message",this.processSDKMessage)}componentDidUpdate(){this.handleUserLogic(),this.handleGameDataTimeoutStart(),this.handleUnitySyncTimeStart()}componentWillUnmount(){this.clearUnitySyncTime(),this.clearGameDataTimeout(),window.removeEventListener("message",this.processSDKMessage)}handleUnitySyncTimeStart(){"NOT_STARTED"===this.props.gameLoadStatus||"aps"!==m.Z.Instance.getCurrentSyncType()||void 0!==this.syncTimerInterval||(this.logger.debug("starting interval sync for user"),this.syncTimerInterval=window.setInterval((async()=>{"aps"===m.Z.Instance.getCurrentSyncType()&&this.props.upConnector.syncUnityData(!0)}),(0,M.getSyncTimerMs)()))}handleUserLogic(){var e;this.context.hasUserLoaded&&(null!==(e=this.context)&&void 0!==e&&e.userId?this.handleForUser():this.handleForNoUser())}render(){return(0,p.jsx)(p.Fragment,{children:this.state.showReloadPopup&&(0,p.jsx)(F,{onReload:this.onSelectReload})})}clearUnitySyncTime(){window.clearInterval(this.syncTimerInterval),this.syncTimerInterval=void 0}clearGameDataTimeout(){window.clearTimeout(this.timeout)}}N.contextType=d.N;const E=(0,k.q)((0,b.Z)(N));var _=s(72071);const O=()=>{const{hasUserLoaded:e}=a.useContext(d.N),{gameLoadStatus:t}=a.useContext(_.r);if("NOT_STARTED"===t&&!e)return null;const s=(0,r.NI)().loader;return"iframe"===s&&(0,l.x3)()?(0,p.jsx)(R,{loader:"iframe"}):"ruffle"===s&&(0,l.o5)()?(0,p.jsx)(R,{loader:"ruffle"}):r.Fw.includes(s)&&(0,l.v9)()?(0,p.jsx)(E,{}):null}},52012:(e,t,s)=>{s.r(t),s.d(t,{getExistingIndexedData:()=>D,getExistingPlayerPrefUpdatedAtTz:()=>f,getLastSyncTimeOfIDBTz:()=>U,getPlayedTimeInLS:()=>v,getSyncTimerMs:()=>g,savePlayedTimeInLS:()=>P,setAPIDataToIDB:()=>x,setSyncTimeOfIndexDb:()=>w});var a=s(41989),r=s.n(a),i=s(94845),o=s(90831),n=s(22870),d=s(74082);const h="/idbfs",c="FILE_DATA";let l;const m=e=>+new Date(e),g=()=>{const{apsSyncTimerMs:e}=(0,o.NI)();return e||3e4},u=()=>window.indexedDB,p=()=>{const e=(()=>{const e=window.location.origin+window.location.pathname,t=e.substring(0,e.lastIndexOf("/"));return r()(t)})(),t=`/idbfs/${e}/PlayerPrefs`;const s=(0,o.NI)().loaderOptions,a=s.unitySaveFileNames?s.unitySaveFileNames[0]:void 0,i=[`/idbfs/${e}`,t];return a&&i.push(`/idbfs/${e}/${a}`),i},S=e=>{const t=e.target.result,s=e.target.transaction;let a;a=t.objectStoreNames.contains(c)?s.objectStore(c):t.createObjectStore(c),a.indexNames.contains("timestamp")||a.createIndex("timestamp","timestamp",{unique:!1})},y=(e,t)=>new Promise(((s,a)=>{e.transaction(c).objectStore(c).get(t).onsuccess=e=>{try{const a=e.target.result;if(!a)return s(null);if(!a.timestamp)return console.error("[APS-U] IDB data incomplete: "+t+a),s(null);const r=new Date(a.timestamp).setMilliseconds(0);s(r)}catch(a){n.kg.debug("[APS-U] Error:",a)}}})),f=()=>{const e=u().open(h,21);return new Promise(((t,s)=>{e.onupgradeneeded=S,e.onsuccess=async()=>{const s=e.result;s.objectStoreNames.contains(c)||s.createObjectStore(c);const a=p();let r=await y(s,a[1]);r||(r=await y(s,a[0])),t(r)},e.onerror=e=>{n.kg.debug("[APS-U] Error:",e),s()}}))},D=()=>{const e=u().open(h,21);return new Promise(((t,s)=>{e.onupgradeneeded=S,e.onsuccess=()=>{const a=e.result,r=p(),o=a.transaction(c),n=o.objectStore(c),d={};let h;r.forEach((e=>{n.get(e).onsuccess=t=>{const a=t.target.result;if(a){var r;a.timestamp||s("[APS-U] IDB data incomplete: "+e+a);const t=new Date(a.timestamp);t.getTime()>((null===(r=h)||void 0===r?void 0:r.getTime())||0)&&(h=t);const n={...a,timestamp:m(a.timestamp)};a.contents&&(n.contents=(o=a.contents,(0,i.hd)(o))),d[e]=n}var o}})),o.oncomplete=()=>{Object.keys(d).length>0?t({data:d,updatedAtTz:m(h)}):t({data:null})},o.onerror=e=>{s(e)}}}))},P=e=>{const{gameSlug:t}=(0,o.NI)();d.m.Instance.setItem(`_czy_${t}_pt`,`${e}`)},v=()=>{const{gameSlug:e}=(0,o.NI)(),t=d.m.Instance.getItem(`_czy_${e}_pt`)||"0";return JSON.parse(t)},w=e=>{l=e},U=()=>l,I=(e,t)=>{const s=u().open(h,21);return new Promise(((a,r)=>{s.onupgradeneeded=S,s.onsuccess=()=>{const o=s.result.transaction(c,"readwrite");t.forEach((t=>{const s=e[t];if(s){s.timestamp||r("[APS-U] API data incomplete: "+e);const n={...s,timestamp:new Date(s.timestamp)};n.contents&&(n.contents=(a=n.contents,new Uint8Array((0,i.fJ)(a)))),o.objectStore(c).put(n,t)}var a})),o.oncomplete=()=>{a(null)},o.onerror=()=>{r(null)}}}))},x=async(e,t)=>{try{const s=JSON.parse(e.data),a=p();await I(s,a),l=t}catch(s){n.kg.debug("[APS-U] Set err: ",s,e.data)}}},91423:(e,t,s)=>{s.d(t,{Z:()=>i});s(47313);var a=s(31080),r=s(46417);const i=e=>{let{onClick:t,className:s,responsive:i,customStyle:o,children:n,variant:d="contained"}=e;return(0,r.jsx)(a.v,{responsive:!!i,variant:d,className:s,onClick:t,style:o,children:n})}}}]);